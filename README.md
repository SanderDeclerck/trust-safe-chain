# Aikido Trust Safe-Chain DevContainer Feature

A DevContainer feature that automatically detects and installs Aikido safe-chain proxy SSL certificates to the system trust store.

## What is Aikido Safe-Chain?

[Aikido safe-chain](https://www.aikido.dev/safe-chain) is a security proxy that sits between your application and package registries like npmjs.org, scanning packages for malware and vulnerabilities before they reach your system.

## What This Feature Does

This feature:
1. Checks if your npm registry connection is proxied through Aikido safe-chain
2. If detected, automatically extracts and installs the Aikido root certificate to your system trust store
3. If not detected, exits gracefully without making changes

This ensures that HTTPS connections to package registries work seamlessly when using Aikido's security proxy.

## Usage

Add this feature to your `devcontainer.json`:

```jsonc
{
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "features": {
        "ghcr.io/sanderdeclerck/trust-safe-chain/trust-safe-chain:1": {}
    }
}
```

## Features

- **Zero configuration**: Automatically detects if Aikido safe-chain is in use
- **Safe**: Only installs certificates when properly validated
- **Graceful**: Exits without error if Aikido safe-chain is not detected
- **Debian/Ubuntu compatible**: Works on Debian and Ubuntu-based images

## Requirements

- Debian or Ubuntu-based container image
- `openssl` (usually pre-installed)
- `update-ca-certificates` (usually pre-installed)

For best results, use with the common-utils feature:

```jsonc
{
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "features": {
        "ghcr.io/devcontainers/features/common-utils:1": {},
        "ghcr.io/sanderdeclerck/trust-safe-chain/trust-safe-chain:1": {}
    }
}
```

## How It Works

1. Connects to `registry.npmjs.org` and retrieves the SSL certificate chain
2. Extracts the root certificate
3. Validates that the issuer is "Aikido safe-chain proxy"
4. If validated, copies the certificate to `/usr/local/share/ca-certificates/`
5. Runs `update-ca-certificates` to update the system trust store

## Development

### Repository Structure

```
├── src/
│   └── trust-safe-chain/
│       ├── devcontainer-feature.json
│       └── install.sh
├── test/
│   └── trust-safe-chain/
│       ├── scenarios.json
│       ├── test.sh
│       └── with_common_utils.sh
└── README.md
```

### Testing

Tests are run automatically via GitHub Actions on every push and pull request.

To test locally:

```bash
# Install devcontainer CLI
npm install -g @devcontainers/cli

# Run all tests
devcontainer features test -f trust-safe-chain .

# Run specific scenario
devcontainer features test -f trust-safe-chain --skip-autogenerated .
```

### Publishing

Features are published to GitHub Container Registry (GHCR) via the release workflow.

To publish:
1. Update the version in `src/trust-safe-chain/devcontainer-feature.json`
2. Run the "Release dev container features & Generate Documentation" workflow
3. The feature will be published to GHCR with the specified version

## License

See [LICENSE](LICENSE) file.

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.
